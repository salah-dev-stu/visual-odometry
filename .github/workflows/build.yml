name: Build and Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-ubuntu:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            libopencv-dev \
            libeigen3-dev

      - name: Cache PoseLib
        id: cache-poselib
        uses: actions/cache@v4
        with:
          path: poselib_src
          key: poselib-ubuntu-${{ hashFiles('.github/workflows/build.yml') }}

      - name: Clone and build PoseLib
        if: steps.cache-poselib.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/PoseLib/PoseLib.git poselib_src
          cd poselib_src
          mkdir -p build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc)

      - name: Build vo_submission
        run: |
          mkdir -p build && cd build
          cmake ..
          make -j$(nproc)

      - name: Test binary runs
        run: |
          ./build/vo_submission --help || echo "Usage test complete"

      - name: Upload Ubuntu binary
        uses: actions/upload-artifact@v4
        with:
          name: vo_submission-ubuntu
          path: build/vo_submission

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache Chocolatey packages
        id: cache-choco
        uses: actions/cache@v4
        with:
          path: C:\tools\opencv
          key: choco-opencv-windows-v1

      - name: Install OpenCV via Chocolatey
        if: steps.cache-choco.outputs.cache-hit != 'true'
        run: |
          choco install opencv -y

      - name: Cache Eigen
        id: cache-eigen
        uses: actions/cache@v4
        with:
          path: |
            eigen-3.4.0
            eigen3_install
          key: eigen-3.4.0-windows-v1

      - name: Download and setup Eigen
        if: steps.cache-eigen.outputs.cache-hit != 'true'
        run: |
          Invoke-WebRequest -Uri "https://gitlab.com/libeigen/eigen/-/archive/3.4.0/eigen-3.4.0.zip" -OutFile eigen.zip
          Expand-Archive eigen.zip -DestinationPath .
          mkdir eigen3_install
          cd eigen-3.4.0
          mkdir build
          cd build
          cmake .. -DCMAKE_INSTALL_PREFIX="${{ github.workspace }}/eigen3_install"
          cmake --install .

      - name: Cache PoseLib
        id: cache-poselib
        uses: actions/cache@v4
        with:
          path: poselib_src
          key: poselib-windows-${{ hashFiles('.github/workflows/build.yml') }}

      - name: Clone and build PoseLib
        if: steps.cache-poselib.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/PoseLib/PoseLib.git poselib_src
          cd poselib_src
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="${{ github.workspace }}/eigen3_install"
          cmake --build . --config Release --parallel

      - name: Build vo_submission
        run: |
          mkdir build
          cd build
          cmake .. -DOpenCV_DIR="C:/tools/opencv/build" -DCMAKE_PREFIX_PATH="${{ github.workspace }}/eigen3_install"
          cmake --build . --config Release --parallel

      - name: Test binary runs
        run: |
          ./build/Release/vo_submission.exe --help
        continue-on-error: true

      - name: Upload Windows binary
        uses: actions/upload-artifact@v4
        with:
          name: vo_submission-windows
          path: build/Release/vo_submission.exe
        if: success()

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          brew install opencv eigen

      - name: Cache PoseLib
        id: cache-poselib
        uses: actions/cache@v4
        with:
          path: poselib_src
          key: poselib-macos-${{ hashFiles('.github/workflows/build.yml') }}

      - name: Clone and build PoseLib
        if: steps.cache-poselib.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/PoseLib/PoseLib.git poselib_src
          cd poselib_src
          mkdir -p build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DEIGEN3_INCLUDE_DIR=$(brew --prefix eigen)/include/eigen3
          make -j$(sysctl -n hw.ncpu)

      - name: Build vo_submission
        run: |
          mkdir -p build && cd build
          cmake .. -DEIGEN3_INCLUDE_DIR=$(brew --prefix eigen)/include/eigen3
          make -j$(sysctl -n hw.ncpu)

      - name: Test binary runs
        run: |
          ./build/vo_submission --help || echo "Usage test complete"

      - name: Upload macOS binary
        uses: actions/upload-artifact@v4
        with:
          name: vo_submission-macos
          path: build/vo_submission
